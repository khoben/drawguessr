##  [DrawGuessr](https://en.wikipedia.org/wiki/Draw_%26_Guess) game: [Telegram Bot Web App](https://core.telegram.org/bots/webapps#implementing-mini-apps)

## Screenshots
<pre>
<img src="README.md-images/w1.png" width="200" /> <img src="README.md-images/w2.png" width="200" /> <img src="README.md-images/w3.png" width="200" />
</pre>

### Built with
- [python 3.11](https://www.python.org/downloads/)
- [aiohttp](https://docs.aiohttp.org/en/stable/) - asynchronous http server
- [aiogram](https://docs.aiogram.dev/en/latest/) - asynchronous framework for Telegram Bot API
- [PostgreSQL](https://www.postgresql.org/) - relational Database

### DrawGuessr Telegram Web App [source](/http_handlers/webapp/)

Telegram Web App consists of [a simple HTTP server](/http_handlers/webapp/miniapp.py) that serves static `.html`, `.js` and `.css` files, uses [SSE](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events) to listen for game updates, and a [vanilla js client with canvas](/http_handlers/webapp/static/js/script.js) controlled by [Telegram chat/group bot](handlers).

## Prepare

1. [Create Telegram Bot](https://core.telegram.org/bots/tutorial#obtain-your-bot-token)

    1.1. Disable [privacy mode](https://core.telegram.org/bots/features#privacy-mode) for accessing to user messages and allow groups thru @BotFather (`/mybots`)

    1.2. You will need a domain with SSL; during development, you can use [ngrok](https://ngrok.com/download) or the [port forwarder built into vscode](https://code.visualstudio.com/docs/editor/port-forwarding).

2. [Create Telegram Web App](https://t.me/BotFather):

    Send command to @BotFather and attach app to the bot:
    ```
    /newapp
    ```

3. Setup Postgres database or use it from Docker

4. Fill `.env` with your data

    [.env-example](.env-example) - env config example.

    <details>
    <summary><b>.env</b> overview</b></summary>

    ```bash
    # Bot token from @BotFather
    BOT_TOKEN=1234:fokspdokf
    # host.com/bot/{WEBHOOK_ENDPOINT_SECRET} (generated by yourself)
    WEBHOOK_ENDPOINT_SECRET=
    # Telegram Bot API security token (generated by yourself)
    TELEGRAM_BOT_API_SECRET_TOKEN=
    # Telegram Web app direct url from @BotFather
    TELEGRAM_BOT_WEB_APP_URL=
    # Database URL
    DB_URL=postgresql://user:user@postgres:5432/user
    # Host domain
    HOST=
    # Local port
    PORT=
    # Initial reusable image via `file_id`
    # can be obtained as follows:
    # 1. Send the image (`./resources/initial_canvas.jpg` ) to your bot
    # 2. Get `file_id` from this message (e.g., forward message to https://t.me/JsonDumpBot),
    # `file_id` can be used only for this bot
    INITIAL_CANVAS_FILE_ID=
    ```
    </details>

## Deploy

<details>
<summary>nginx reverse proxy config</summary>

```conf
...
server {
    ...
    location /bot/ {
        proxy_pass http://localhost:PORT;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /web/ {
        proxy_pass http://localhost:PORT;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    ...
}
...
```
</details>

### [Docker](https://docs.docker.com/compose/install/):

```bash
docker-compose build # build
docker-compose up -d # start
```

### [Heroku buildpack](https://devcenter.heroku.com/articles/buildpacks):
Push to any PaaS that supports heroku buildpacks with provided environment variables

### Locally:
1. Create and activate python virtual environment

    ```bash
    python -m venv myvenv
    source ./myvenv/Scripts/activate # linux
    myvenv/Scripts/activate # windows
    ```
2. Install dependencies

    ```bash
    pip install -r requirements.txt
    ```
3. Run

    ```bash
    python main.py
    ```

## Working with localizations (using *Babel*)

1. Extract `_("string")` strings:

    ```bash
    pybabel extract --input-dirs=. --ignore-dirs=venv -o ./locales/messages.pot
    ```
2. Add language (`en` - language code):

    ```bash
    pybabel init -i locales/messages.pot -d locales -D messages -l en
    ```
3. Update localizations:

    ```bash
    pybabel update -d locales -D messages -i locales/messages.pot
    ```
4. Do translation in localizations files (`*.po`)
5. Compile localizations:

    ```bash
    pybabel compile -d locales -D messages
    ```

